name: Purge All GitHub Caches

on:
  workflow_dispatch:

jobs:
  purge-cache:
    runs-on: ubuntu-latest
    permissions:
      actions: write
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Purge all caches using GitHub API
        run: |
          set -x
          
          echo "========================================="
          echo "üóëÔ∏è  GitHub Cache Purge - API Method"
          echo "========================================="
          echo "Repository: $GITHUB_REPOSITORY"
          echo "Started at: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo ""
          
          # GitHub CLI version
          echo "GitHub CLI version:"
          gh --version
          echo ""
          
          TOTAL_DELETED=0
          TOTAL_FAILED=0
          PAGE=1
          
          while true; do
            echo "========================================="
            echo "üîÑ Processing Page $PAGE"
            echo "========================================="
          
            # Fetch caches using GitHub API with pagination
            echo "Fetching caches from API (page $PAGE, per_page=100)..."
            RESPONSE=$(gh api \
              -H "Accept: application/vnd.github+json" \
              "repos/{owner}/{repo}/actions/caches?per_page=100&page=${PAGE}" 2>&1)
          
            API_EXIT_CODE=$?
          
            if [ $API_EXIT_CODE -ne 0 ]; then
              echo "‚ùå API call failed with exit code: $API_EXIT_CODE"
              echo "Response: $RESPONSE"
              exit 1
            fi
          
            # Save response for debugging
            echo "$RESPONSE" > "/tmp/caches_page_${PAGE}.json"
            echo "Response saved to: /tmp/caches_page_${PAGE}.json"
          
            # Count caches in this page
            CACHE_COUNT=$(echo "$RESPONSE" | jq '.actions_caches | length')
            echo "Caches found in this page: $CACHE_COUNT"
          
            if [ "$CACHE_COUNT" -eq 0 ]; then
              echo "No more caches found. Finished!"
              break
            fi
          
            # Display cache details (simplified)
            echo ""
            echo "üìã Caches in this page:"
            echo "$RESPONSE" | jq -r '.actions_caches[] | "  ID: \(.id) | Key: \(.key) | Size: \(.size_in_bytes) bytes | Created: \(.created_at)"' || {
              echo "  ‚ö†Ô∏è  Failed to parse cache details"
              echo "  Showing first 20 lines of response:"
              echo "$RESPONSE" | head -20
            }
            echo ""
          
            # Delete each cache
            COUNTER=0
            echo "Starting deletion process..."
          
            # Extract all cache IDs into an array
            IDS=$(echo "$RESPONSE" | jq -r '.actions_caches[].id')
          
            for cache_id in $IDS; do
              ((COUNTER++))
          
              echo "---"
              echo "[$COUNTER/$CACHE_COUNT] Deleting cache ID: $cache_id"
          
              DELETE_RESPONSE=$(gh api \
                --method DELETE \
                -H "Accept: application/vnd.github+json" \
                "repos/{owner}/{repo}/actions/caches/${cache_id}" 2>&1)
          
              DELETE_EXIT_CODE=$?
          
              if [ $DELETE_EXIT_CODE -eq 0 ]; then
                echo "  ‚úÖ Successfully deleted"
                ((TOTAL_DELETED++))
              else
                echo "  ‚ùå Failed to delete"
                echo "  Exit code: $DELETE_EXIT_CODE"
                echo "  Response: $DELETE_RESPONSE"
                ((TOTAL_FAILED++))
              fi
            done
          
            echo ""
            echo "üìä Page $PAGE Summary:"
            echo "  Processed: $CACHE_COUNT caches"
            echo "  Total deleted so far: $TOTAL_DELETED"
            echo "  Total failed so far: $TOTAL_FAILED"
            echo ""
          
            ((PAGE++))
          
            # Safety check
            if [ $PAGE -gt 100 ]; then
              echo "‚ö†Ô∏è  Reached maximum pages (100). Stopping."
              break
            fi
          
            # Small delay to avoid rate limiting
            echo "Waiting 1 second before next page..."
            sleep 1
          done
          
          echo ""
          echo "========================================="
          echo "‚úÖ Cache Purge Completed!"
          echo "========================================="
          echo "Ended at: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo ""
          echo "üìä Final Statistics:"
          echo "  Total pages processed: $((PAGE - 1))"
          echo "  Total caches deleted: $TOTAL_DELETED"
          echo "  Total failures: $TOTAL_FAILED"
          if [ $((TOTAL_DELETED + TOTAL_FAILED)) -gt 0 ]; then
            echo "  Success rate: $((TOTAL_DELETED * 100 / (TOTAL_DELETED + TOTAL_FAILED)))%"
          fi
          echo "========================================="
          
          set +x
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Final verification
        run: |
          echo ""
          echo "üîç Final cache count check..."
          REMAINING=$(gh cache list --limit 10 --json id --jq '. | length')
          
          if [ "$REMAINING" -eq 0 ]; then
            echo "‚úÖ All caches successfully purged!"
          else
            echo "‚ö†Ô∏è  $REMAINING cache(es) still remain"
            gh cache list --limit 10
          fi
        env:
          GH_TOKEN: ${{ github.token }}