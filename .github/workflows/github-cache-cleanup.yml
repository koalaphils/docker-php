name: Purge All GitHub Caches

on:
  workflow_dispatch:

jobs:
  purge-cache:
    runs-on: ubuntu-latest
    permissions:
      actions: write
      contents: read

    steps:
      - name: Purge all caches
        run: |
          set -x
          
          echo "========================================="
          echo "üóëÔ∏è  Purging All GitHub Caches"
          echo "========================================="
          echo "Repository: $GITHUB_REPOSITORY"
          echo "Started at: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo ""
          
          TOTAL_DELETED=0
          TOTAL_FAILED=0
          ITERATION=1
          
          while true; do
            echo "========================================="
            echo "üîÑ Iteration $ITERATION"
            echo "========================================="
          
            # Get cache IDs (limit 100 per iteration)
            echo "Fetching cache IDs..."
            CACHE_IDS=$(gh cache list --limit 100 --json id --jq '.[].id' 2>&1)
            LIST_EXIT_CODE=$?
          
            if [ $LIST_EXIT_CODE -ne 0 ]; then
              echo "‚ùå Failed to list caches"
              echo "Output: $CACHE_IDS"
              exit 1
            fi
          
            # Check if empty
            if [ -z "$CACHE_IDS" ]; then
              echo "No more caches found. Done!"
              break
            fi
          
            # Count caches
            CACHE_COUNT=$(echo "$CACHE_IDS" | wc -l)
            echo "Found $CACHE_COUNT caches to delete"
            echo ""
          
            # Show cache details
            echo "üìã Cache details:"
            gh cache list --limit 100 2>&1 | head -20
            echo ""
          
            # Delete each cache
            COUNTER=0
            for cache_id in $CACHE_IDS; do
              ((COUNTER++))
              echo "[$COUNTER/$CACHE_COUNT] Deleting cache ID: $cache_id"
          
              if gh cache delete "$cache_id" 2>&1; then
                echo "  ‚úÖ Deleted"
                ((TOTAL_DELETED++))
              else
                echo "  ‚ùå Failed"
                ((TOTAL_FAILED++))
              fi
            done
          
            echo ""
            echo "üìä Iteration $ITERATION Summary:"
            echo "  Deleted: $COUNTER caches"
            echo "  Total deleted: $TOTAL_DELETED"
            echo "  Total failed: $TOTAL_FAILED"
            echo ""
          
            ((ITERATION++))
          
            if [ $ITERATION -gt 50 ]; then
              echo "‚ö†Ô∏è  Reached 50 iterations. Stopping."
              break
            fi
          
            sleep 1
          done
          
          echo ""
          echo "========================================="
          echo "‚úÖ Purge Completed!"
          echo "========================================="
          echo "Ended at: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo "Total deleted: $TOTAL_DELETED"
          echo "Total failed: $TOTAL_FAILED"
          echo "========================================="
          
          set +x
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Verify
        run: |
          echo ""
          echo "üîç Verification:"
          REMAINING=$(gh cache list --limit 10 --json id --jq '. | length' 2>&1)
          
          if [ "$REMAINING" -eq 0 ]; then
            echo "‚úÖ All caches purged successfully!"
          else
            echo "‚ö†Ô∏è  $REMAINING cache(es) still remain"
            gh cache list --limit 10
          fi
        env:
          GH_TOKEN: ${{ github.token }}